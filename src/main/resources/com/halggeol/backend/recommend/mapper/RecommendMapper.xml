<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.halggeol.backend.recommend.mapper.RecommendMapper">
  <select id="selectRecommendProducts" resultType="com.halggeol.backend.recommend.dto.RecommendResponseDTO">
    SELECT
      t.product_id AS productId,
      COALESCE(
        dp.name,      -- 예금 상품명 (D)
        sp.name,      -- 적금 상품명 (S)
        pp.name,      -- 연금 상품명 (A, C)
        fp.name,      -- 펀드 상품명 (F)
        fxp.name      -- 외화 상품명 (X)
      ) AS name,
      t.match_score AS matchScore
    FROM (
           -- rec_item 테이블에서 각 상품별 ID와 매치 스코어를 UNION ALL로 추출합니다.
           SELECT
             product1_id AS product_id,
             product1_match_score AS match_score,
             user_id
           FROM rec_item
           WHERE product1_id IS NOT NULL

           UNION ALL

           SELECT
             product2_id AS product_id,
             product2_match_score AS match_score,
             user_id
           FROM rec_item
           WHERE product2_id IS NOT NULL

           UNION ALL

           SELECT
             product3_id AS product_id,
             product3_match_score AS match_score,
             user_id
           FROM rec_item
           WHERE product3_id IS NOT NULL

           UNION ALL

           SELECT
             product4_id AS product_id,
             product4_match_score AS match_score,
             user_id
           FROM rec_item
           WHERE product4_id IS NOT NULL

           UNION ALL

           SELECT
             product5_id AS product_id,
             product5_match_score AS match_score,
             user_id
           FROM rec_item
           WHERE product5_id IS NOT NULL
         ) AS t

           LEFT JOIN deposit dp
                     ON t.product_id = dp.id AND t.product_id LIKE 'D%'
           LEFT JOIN savings sp
                     ON t.product_id = sp.id AND t.product_id LIKE 'S%'
           LEFT JOIN pension pp
                     ON t.product_id = pp.id AND (t.product_id LIKE 'A%' OR t.product_id LIKE 'C%')
           LEFT JOIN fund fp
                     ON t.product_id = fp.id AND t.product_id LIKE 'F%'
           LEFT JOIN forex fxp
                     ON t.product_id = fxp.id AND t.product_id LIKE 'X%'
    WHERE t.user_id = #{userId}

  </select>
</mapper>