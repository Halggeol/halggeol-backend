<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.halggeol.backend.dashboard.mapper.DashboardMapper">
  <select id="getAvgRegretScoreByUserId" resultType="java.lang.Double">
    SELECT
      CASE
        WHEN cnt = 0 THEN NULL
        ELSE total / cnt
        END AS avg_regret_score
    FROM (
           SELECT
             SUM(IFNULL(product1_regret_score,0) + IFNULL(product2_regret_score,0)
               + IFNULL(product3_regret_score,0) + IFNULL(product4_regret_score,0)
               + IFNULL(product5_regret_score,0)) AS total,
             SUM( (product1_regret_score IS NOT NULL) + (product2_regret_score IS NOT NULL)
               + (product3_regret_score IS NOT NULL) + (product4_regret_score IS NOT NULL)
               + (product5_regret_score IS NOT NULL) ) AS cnt
           FROM rec_item
           WHERE user_id = #{userId}
         ) t;
  </select>

  <select id="getAssetsOneYearByUserId" resultType="com.halggeol.backend.dashboard.dto.DashboardAssetResponseDTO">
    SELECT
      collect_date AS date,
      asset
    FROM mydata
    WHERE user_id = #{userId}
      AND collect_date <![CDATA[ >= ]]> DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
      AND collect_date <![CDATA[ <= ]]> CURDATE()
    ORDER BY collect_date ASC;
  </select>
  <select id="getPortfolioByUserId" resultType="com.halggeol.backend.dashboard.dto.DashboardPortfolioResponseDTO">
    SELECT
      CASE
        WHEN mp.product_id LIKE 'D%' THEN 'deposit'
        WHEN mp.product_id LIKE 'S%' THEN 'savings'
        WHEN mp.product_id LIKE 'A%' OR mp.product_id LIKE 'C%' THEN 'pension'
        WHEN mp.product_id LIKE 'F%' THEN 'fund'
        WHEN mp.product_id LIKE 'X%' THEN 'forex'
        ELSE 'unknown'
        END AS type,
      CAST(
        SUM(mp.amount) * 1.0 / (
          SELECT SUM(mp2.amount)
          FROM myproduct mp2
          WHERE mp2.mydata_id = (
            SELECT id
            FROM mydata
            WHERE user_id = #{userId}
            ORDER BY collect_date DESC, id DESC
            LIMIT 1
          )
        ) AS CHAR
      ) AS ratio
    FROM myproduct mp
    WHERE mp.mydata_id = (
      SELECT id
      FROM mydata
      WHERE user_id = #{userId}
      ORDER BY collect_date DESC, id DESC
      LIMIT 1
    )
    GROUP BY type
    ORDER BY type ASC;
  </select>

  <select id="getFeedbackRatioByUserId" resultType="java.lang.Double">
    SELECT
      CASE WHEN denom = 0 THEN 0.0 ELSE num / denom END AS feedback_ratio
    FROM (
           SELECT
             SUM(
               IF(TRIM(COALESCE(product1_status,'')) = '회고', 1, 0) +
               IF(TRIM(COALESCE(product2_status,'')) = '회고', 1, 0) +
               IF(TRIM(COALESCE(product3_status,'')) = '회고', 1, 0) +
               IF(TRIM(COALESCE(product4_status,'')) = '회고', 1, 0) +
               IF(TRIM(COALESCE(product5_status,'')) = '회고', 1, 0)
             ) AS num,
             SUM(
               IF(TRIM(COALESCE(product1_status,'')) != '', 1, 0) +
               IF(TRIM(COALESCE(product2_status,'')) != '', 1, 0) +
               IF(TRIM(COALESCE(product3_status,'')) != '', 1, 0) +
               IF(TRIM(COALESCE(product4_status,'')) != '', 1, 0) +
               IF(TRIM(COALESCE(product5_status,'')) != '', 1, 0)
             ) AS denom
           FROM rec_item
           WHERE user_id = #{userId}
         ) t
  </select>
</mapper>