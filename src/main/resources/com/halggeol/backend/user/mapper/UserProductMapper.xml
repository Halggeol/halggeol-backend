<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.halggeol.backend.user.mapper.UserProductMapper">
  <select id="getUserProductsByUserId" resultType="com.halggeol.backend.user.dto.UserProductResponseDTO">
    WITH LatestMydata AS (
      SELECT id
      FROM mydata
      WHERE user_id = #{userId}
      ORDER BY collect_date DESC, id DESC
      LIMIT 1
    ),
    UserLatestMyProducts AS (
      SELECT mp.product_id, mp.amount
      FROM myproduct mp
      JOIN LatestMydata lm ON mp.mydata_id = lm.id
    )

    SELECT
      ulmp.product_id AS productId,
      d.name,
      d.company,
      CAST(d.min_save_term AS CHAR) AS tag1,
      CAST(d.max_save_term AS CHAR) AS tag2,
      NULL AS tag3,
      d.prime_rate AS title,
      d.rate AS subTitle,
      ulmp.amount,
      CASE WHEN s.product_id IS NOT NULL THEN true ELSE false END AS isScraped
    FROM UserLatestMyProducts ulmp
    JOIN deposit d ON ulmp.product_id = d.id
    LEFT JOIN scrap s ON s.user_id = #{userId} AND s.product_id = ulmp.product_id
    WHERE SUBSTRING(ulmp.product_id, 1, 1) = 'D'

    UNION ALL

    SELECT
      ulmp.product_id AS productId,
      s.name,
      s.company,
      CAST(s.min_save_term AS CHAR) AS tag1,
      CAST(s.max_save_term AS CHAR) AS tag2,
      NULL AS tag3,
      s.prime_rate AS title,
      s.rate AS subTitle,
      ulmp.amount,
      CASE WHEN sc.product_id IS NOT NULL THEN true ELSE false END AS isScraped
    FROM UserLatestMyProducts ulmp
    JOIN savings s ON ulmp.product_id = s.id
    LEFT JOIN scrap sc ON sc.user_id = #{userId} AND sc.product_id = ulmp.product_id
    WHERE SUBSTRING(ulmp.product_id, 1, 1) = 'S'

    UNION ALL

    SELECT
      ulmp.product_id AS productId,
      p.name,
      p.company,
      p.pension_kind AS tag1,
      CAST(p.risk AS CHAR) AS tag2,
      NULL AS tag3,
      CASE
        WHEN SUBSTRING(ulmp.product_id, 1, 1) = 'A' THEN p.pension_price_movement
        WHEN SUBSTRING(ulmp.product_id, 1, 1) = 'C' THEN p.rate
        ELSE NULL
      END AS title,
      CASE
        WHEN SUBSTRING(ulmp.product_id, 1, 1) = 'A' THEN NULL
        WHEN SUBSTRING(ulmp.product_id, 1, 1) = 'C' THEN p.min_guarantee_rate
        ELSE NULL
      END AS subTitle,
      ulmp.amount,
      CASE WHEN sc.product_id IS NOT NULL THEN true ELSE false END AS isScraped
    FROM UserLatestMyProducts ulmp
    JOIN pension p ON ulmp.product_id = p.id
    LEFT JOIN scrap sc ON sc.user_id = #{userId} AND sc.product_id = ulmp.product_id
    WHERE SUBSTRING(ulmp.product_id, 1, 1) IN ('A', 'C')

    UNION ALL

    SELECT
      ulmp.product_id AS productId,
      f.name,
      f.company,
      f.category AS tag1,
      f.theme AS tag2,
      CAST(f.risk AS CHAR) AS tag3,
      f.rate AS title,
      f.fund_price_movement AS subTitle,
      ulmp.amount,
      CASE WHEN sc.product_id IS NOT NULL THEN true ELSE false END AS isScraped
    FROM UserLatestMyProducts ulmp
    JOIN fund f ON ulmp.product_id = f.id
    LEFT JOIN scrap sc ON sc.user_id = #{userId} AND sc.product_id = ulmp.product_id
    WHERE SUBSTRING(ulmp.product_id, 1, 1) = 'F'

    UNION ALL

    SELECT
      ulmp.product_id AS productId,
      fx.name,
      fx.company,
      fx.currency AS tag1,
      NULL AS tag2,
      NULL AS tag3,
      fx.rate AS title,
      fx.rate_give_way AS subTitle,
      ulmp.amount,
      CASE WHEN sc.product_id IS NOT NULL THEN true ELSE false END AS isScraped
    FROM UserLatestMyProducts ulmp
    JOIN forex fx ON ulmp.product_id = fx.id
    LEFT JOIN scrap sc ON sc.user_id = #{userId} AND sc.product_id = ulmp.product_id
    WHERE SUBSTRING(ulmp.product_id, 1, 1) = 'X'
    
    ORDER BY productId ASC;
  </select>
</mapper>